From a72cc65e8a56bccfb48c056c1ef0de773974eeb7 Mon Sep 17 00:00:00 2001
From: zhongfly <11155705+zhongfly@users.noreply.github.com>
Date: Sun, 28 Dec 2025 13:52:41 +0800
Subject: [PATCH] openssl: use winstore by default

---
 ...openssl-0001-use-winstore-by-default.patch | 27 +++++++++++++++++++
 packages/openssl.cmake                        |  1 +
 2 files changed, 28 insertions(+)
 create mode 100644 packages/openssl-0001-use-winstore-by-default.patch

diff --git a/packages/openssl-0001-use-winstore-by-default.patch b/packages/openssl-0001-use-winstore-by-default.patch
new file mode 100644
index 0000000..7a4921f
--- /dev/null
+++ b/packages/openssl-0001-use-winstore-by-default.patch
@@ -0,0 +1,27 @@
+From e0237d629397d6732fd91276f6af19cc7061f683 Mon Sep 17 00:00:00 2001
+From: Andarwinux <Andarwinux@users.noreply.github.com>
+Date: Fri, 8 Aug 2025 00:00:00 +0000
+Subject: [PATCH] use winstore by default
+
+---
+ crypto/x509/by_store.c | 4 ++++
+ 1 file changed, 4 insertions(+)
+
+diff --git a/crypto/x509/by_store.c b/crypto/x509/by_store.c
+index 3fa3471..e04b335 100644
+--- a/crypto/x509/by_store.c
++++ b/crypto/x509/by_store.c
+@@ -130,6 +130,10 @@ static int by_store_ctrl_ex(X509_LOOKUP *ctx, int cmd, const char *argp,
+ {
+     switch (cmd) {
+     case X509_L_ADD_STORE:
++#ifdef _WIN32
++        if (argp == NULL)
++            argp = "org.openssl.winstore://";
++#endif
+         if (argp != NULL) {
+             STACK_OF(CACHED_STORE) *stores = X509_LOOKUP_get_method_data(ctx);
+             CACHED_STORE *store = OPENSSL_zalloc(sizeof(*store));
+-- 
+2.50.1
+
diff --git a/packages/openssl.cmake b/packages/openssl.cmake
index 5bb526c..2ad087d 100644
--- a/packages/openssl.cmake
+++ b/packages/openssl.cmake
@@ -9,6 +9,7 @@ ExternalProject_Add(openssl
     GIT_CLONE_POST_COMMAND "sparse-checkout set --no-cone /* !test"
     GIT_SUBMODULES ""
     UPDATE_COMMAND ""
+    PATCH_COMMAND ${EXEC} git am --3way ${CMAKE_CURRENT_SOURCE_DIR}/openssl-*.patch
     CONFIGURE_COMMAND ${EXEC} sed -i [['/__int64 ossl_ssize_t/i #include <stdint.h>']] <SOURCE_DIR>/include/openssl/e_os2.h
     COMMAND ${EXEC} CONF=1 <SOURCE_DIR>/Configure
         --cross-compile-prefix=${TARGET_ARCH}-
-- 
2.52.0.windows.1
